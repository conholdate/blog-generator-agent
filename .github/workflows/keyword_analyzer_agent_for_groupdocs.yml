name: Blog Keyword Analyzer for GroupDocs

on:
  workflow_dispatch:
    inputs:
      product:
        description: "Product name (e.g., GroupDocs.Viewer)."
        type: string
        required: true
      platform:
        description: "Platform (e.g., net, java, python)."
        type: string
        required: true
        default: "java"
      keywords_file:
        description: "Path to keywords CSV in repo (e.g., content/GroupDocs/keywords.csv)."
        type: string
        required: false
        default: "content/GroupDocs/keywords.csv"

      use_serp_api:
        description: "If true, ingest keywords using SerpAPI (requires SERPAPI_KEY)."
        type: boolean
        required: false
        default: false

      serp_topic:
        description: "SerpAPI topic seed (used only if use_serp_api=true)."
        type: string
        required: false
        default: ""

      top_clusters:
        description: "How many top clusters to keep (number as text)."
        type: string
        required: false
        default: "15"

      use_content_index:
        description: "If true, clone blog repo and dedupe topics against existing posts."
        type: boolean
        required: false
        default: false

      include_product_in_title:
        description: "If true, enforce product name in generated topic titles. If false, ensure product name is NOT used in titles."
        type: boolean
        required: false
        default: true

permissions:
  contents: write

jobs:
  run-kra:
    runs-on: ubuntu-latest

    env:
      BRAND: "GroupDocs"
      KRA_OUTPUT_DIR: "content/GroupDocs/output"
      KRA_METRICS_DB_PATH: "content/kra_metrics_db.json"

      PROFESSIONALIZE_BASE_URL: "https://llm.professionalize.com/v1"
      PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}

      BLOG_CONTENT_REPO: "GroupDocs/groupdocs-blog"
      BLOG_CONTENT_ROOT: "blog_content/content/GroupDocs.Blog"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build kra_run.generated.yaml
        run: |
          python - <<'PY'
          from __future__ import annotations
          import os
          from pathlib import Path

          def as_bool(v: str) -> bool:
              return (v or "false").strip().lower() == "true"

          def b(v: bool) -> str:
              return "true" if v else "false"

          brand = os.environ["BRAND"]

          product = os.environ.get("INPUT_PRODUCT", "GroupDocs.Viewer")
          platform = os.environ.get("INPUT_PLATFORM", "java")
          keywords_file = os.environ.get("INPUT_KEYWORDS_FILE", "content/GroupDocs/keywords.csv")
          use_serp_api = as_bool(os.environ.get("INPUT_USE_SERP_API", "false"))
          serp_topic = os.environ.get("INPUT_SERP_TOPIC", "")
          top_clusters = int(os.environ.get("INPUT_TOP_CLUSTERS", "15"))
          use_content_index = as_bool(os.environ.get("INPUT_USE_CONTENT_INDEX", "false"))
          include_product_in_title = as_bool(os.environ.get("INPUT_INCLUDE_PRODUCT_IN_TITLE", "true"))

          locale = "en-US"
          max_rows = 50000
          debug = False

          cfg_path = Path(os.environ["RUNNER_TEMP"]) / "kra_run.generated.yaml"

          cfg_text = (
              "meta:\n"
              "  blog_name: \"\"\n"
              f"  brand: \"{brand}\"\n"
              "  created_at: \"\"\n"
              "  owner: \"content-team\"\n"
              "\n"
              "engine:\n"
              f"  input_file: \"{keywords_file}\"\n"
              f"  use_serp_api: {b(use_serp_api)}\n"
              f"  serp_topic: \"{serp_topic}\"\n"
              "\n"
              f"  brand: \"{brand}\"\n"
              f"  product: \"{product}\"\n"
              f"  platform: \"{platform}\"\n"
              f"  locale: \"{locale}\"\n"
              "\n"
              f"  top_clusters: {top_clusters}\n"
              f"  max_rows: {max_rows}\n"
              f"  use_content_index: {b(use_content_index)}\n"
              f"  include_product_in_title: {b(include_product_in_title)}\n"
              f"  debug: {b(debug)}\n"
              "\n"
              "content_index:\n"
              "  index_file_name: \"index.md\"\n"
              "  file_glob: \"**/index.md\"\n"
          )

          cfg_path.write_text(cfg_text, encoding="utf-8")
          print("Generated config:", cfg_path)
          print(cfg_text)
          PY

          echo "KRA_CFG_PATH=${RUNNER_TEMP}/kra_run.generated.yaml" >> "$GITHUB_ENV"
        env:
          INPUT_PRODUCT: ${{ inputs.product }}
          INPUT_PLATFORM: ${{ inputs.platform }}
          INPUT_KEYWORDS_FILE: ${{ inputs.keywords_file }}
          INPUT_USE_SERP_API: ${{ inputs.use_serp_api }}
          INPUT_SERP_TOPIC: ${{ inputs.serp_topic }}
          INPUT_TOP_CLUSTERS: ${{ inputs.top_clusters }}
          INPUT_USE_CONTENT_INDEX: ${{ inputs.use_content_index }}
          INPUT_INCLUDE_PRODUCT_IN_TITLE: ${{ inputs.include_product_in_title }}

      - name: Run KRA
        run: |
          mkdir -p "${KRA_OUTPUT_DIR}"
          python scripts/run_kra_from_config.py --config "${KRA_CFG_PATH}"

      - name: Upload GroupDocs outputs
        uses: actions/upload-artifact@v4
        with:
          name: kra-output-GroupDocs
          path: |
            content/GroupDocs/output/**
            content/groupdocs/output/**
          if-no-files-found: warn
