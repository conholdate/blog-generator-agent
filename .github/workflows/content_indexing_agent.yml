# .github/workflows/content-indexing.yml
name: Content Indexing Agent

on:
  workflow_dispatch:
    inputs:
      brand_yaml:
        description: "Path to brand YAML (repo-relative), e.g. configs/aspose.yaml"
        required: true
        default: "configs/aspose.yaml"
        type: choice
        options:
          - configs/aspose.yaml
          - configs/groupdocs.yaml
          - configs/conholdate.yaml

      product_yaml:
        description: "Path to product YAML (repo-relative), e.g. configs/aspose/cells.yaml"
        required: true
        default: "configs/aspose/cells.yaml"
        type: choice
        options:
          - configs/aspose/cells.yaml
          - configs/aspose/words.yaml
          - configs/aspose/pdf.yaml
          - configs/aspose/slides.yaml
          - configs/aspose/imaging.yaml
          - configs/aspose/barcode.yaml
          - configs/aspose/email.yaml
          - configs/aspose/tasks.yaml
          - configs/aspose/cad.yaml
          - configs/aspose/diagram.yaml
          - configs/aspose/note.yaml
          - configs/aspose/3d.yaml
          - configs/aspose/html.yaml
          - configs/aspose/zip.yaml
          - configs/aspose/ocr.yaml
          - configs/aspose/omr.yaml
          - configs/aspose/svg.yaml
          - configs/aspose/gis.yaml
          - configs/aspose/tex.yaml
          - configs/aspose/page.yaml
          - configs/aspose/font.yaml
          - configs/aspose/psd.yaml
          - configs/aspose/pub.yaml
          - configs/aspose/drawing.yaml
          - configs/aspose/finance.yaml

      platform:
        description: "Target platform (1 platform per run)"
        required: true
        default: "net"
        type: choice
        options:
          - net
          - java
          - python
          - cpp
          - nodejs
          - php
          - android
          - general

      steps:
        description: "CSV repo keys to index (matches your CLI --steps), e.g. blog,docs,tutorials,api"
        required: true
        default: "blog"
        type: choice
        options:
          - blog
          - docs
          - tutorials
          - api

      delete_missing:
        description: "If true, remove entries that no longer exist in source repos"
        required: true
        default: false
        type: boolean

      use_agent:
        description: "If true, run via Agents SDK triage+handoff (--use-agent)"
        required: true
        default: false
        type: boolean

      normalize_topics:
        description: "If true, LLM topic normalization for blogs (--normalize-topics)"
        required: true
        default: true
        type: boolean

      log_level:
        description: "Python log level"
        required: true
        default: "INFO"
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR

permissions:
  contents: write

jobs:
  run-indexer:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      CG_REPO_ROOT: ${{ github.workspace }}
      CG_OUTPUTS_ROOT: ${{ github.workspace }}/outputs

      # Prevent interactive git prompts in CI
      GIT_TERMINAL_PROMPT: "0"

      # Used by your CLI callback (you log its presence).
      PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}

      # Needed if normalize_topics=true or use_agent=true
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      # Token used to clone private Aspose org repos (PAT with appropriate access)
      # Create in repo secrets: ASPOSE_BLOG_TOKEN
      ASPOSE_BLOG_TOKEN: ${{ secrets.ASPOSE_BLOG_TOKEN }}

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Keep GITHUB_TOKEN credentials so we can push commits back
          persist-credentials: true

      - name: Configure git auth for cloning Aspose org repos (private-safe)
        if: ${{ env.ASPOSE_BLOG_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          # Scope token rewrite ONLY to Aspose org repos, so pushing to origin still uses GITHUB_TOKEN.
          git config --global url."https://x-access-token:${ASPOSE_BLOG_TOKEN}@github.com/Aspose/".insteadOf "https://github.com/Aspose/"
          git config --global advice.detachedHead false
          git --version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f pyproject.toml ]; then
            pip install -e .
          else
            echo "No requirements.txt or pyproject.toml found. Add one for CI installs."
            exit 1
          fi

      - name: Run Content Indexing Agent
        shell: bash
        run: |
          set -euo pipefail

          BRAND="${{ inputs.brand_yaml }}"
          PRODUCT="${{ inputs.product_yaml }}"
          PLATFORM="${{ inputs.platform }}"
          STEPS="${{ inputs.steps }}"
          LOG_LEVEL="${{ inputs.log_level }}"

          DELETE_FLAG=""
          if [ "${{ inputs.delete_missing }}" = "true" ]; then
            DELETE_FLAG="--delete-missing"
          fi

          AGENT_FLAG="--no-agent"
          if [ "${{ inputs.use_agent }}" = "true" ]; then
            AGENT_FLAG="--use-agent"
          fi

          NORMALIZE_FLAG="--no-normalize-topics"
          if [ "${{ inputs.normalize_topics }}" = "true" ]; then
            NORMALIZE_FLAG="--normalize-topics"
          fi

          echo "Running indexing:"
          echo "  brand_yaml=$BRAND"
          echo "  product_yaml=$PRODUCT"
          echo "  platform=$PLATFORM"
          echo "  steps=$STEPS"
          echo "  delete_missing=${{ inputs.delete_missing }}"
          echo "  use_agent=${{ inputs.use_agent }}"
          echo "  normalize_topics=${{ inputs.normalize_topics }}"
          echo "  log_level=$LOG_LEVEL"
          echo "  outputs_root=$CG_OUTPUTS_ROOT"

          python -m agent_engine.content_indexer_agent.cli \
            --log-level "$LOG_LEVEL" \
            run \
            --brand "$BRAND" \
            --product "$PRODUCT" \
            --platform "$PLATFORM" \
            --steps "$STEPS" \
            $DELETE_FLAG \
            $AGENT_FLAG \
            $NORMALIZE_FLAG

      - name: Commit and push outputs back to repo (exclude outputs/_repos)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Safety: ensure _repos is never staged (in case something else added it)
          git reset -q outputs/_repos || true
          git restore --staged outputs/_repos 2>/dev/null || true

          # No changes => nothing to commit
          if git diff --cached --quiet; then
            echo "No output changes to commit (excluding outputs/_repos)."
            exit 0
          fi

          MSG="Update indexing outputs: platform=${{ inputs.platform }}, steps=${{ inputs.steps }}, product=${{ inputs.product_yaml }} (run $GITHUB_RUN_ID)"
          git commit -m "$MSG"
          git push
      

      - name: Upload outputs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: content-indexing-outputs
          path: |
            outputs/**
          if-no-files-found: warn