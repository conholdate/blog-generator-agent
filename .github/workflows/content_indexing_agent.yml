# .github/workflows/content-indexing.yml
name: Content Indexing Agent

on:
  workflow_dispatch:
    inputs:
      brand_yaml:
        description: "Path to brand YAML (repo-relative), e.g. configs/aspose.yaml"
        required: true
        default: "configs/aspose.yaml"
        type: choice
        options:
          - configs/blogs.yaml
          - configs/groupdocs.yaml
          - configs/conholdate.yaml

      product_yaml:
        description: "Path to product YAML (repo-relative), e.g. configs/products/cells.yaml"
        required: true
        default: "configs/products/cells.yaml"
        type: choice
        options:
          - configs/products/cells.yaml
          - configs/products/words.yaml
          - configs/products/pdf.yaml
          - configs/products/slides.yaml
          - configs/products/imaging.yaml
          - configs/products/barcode.yaml
          - configs/products/email.yaml
          - configs/products/tasks.yaml
          - configs/products/cad.yaml
          - configs/products/diagram.yaml
          - configs/products/note.yaml
          - configs/products/3d.yaml
          - configs/products/html.yaml
          - configs/products/zip.yaml
          - configs/products/ocr.yaml
          - configs/products/omr.yaml
          - configs/products/svg.yaml
          - configs/products/gis.yaml
          - configs/products/tex.yaml
          - configs/products/page.yaml
          - configs/products/font.yaml
          - configs/products/psd.yaml
          - configs/products/pub.yaml
          - configs/products/drawing.yaml
          - configs/products/finance.yaml

      platform:
        description: "Target platform (1 platform per run)"
        required: true
        default: "net"
        type: choice
        options:
          - net
          - java
          - python
          - cpp
          - nodejs
          - php
          - android
          - general

      steps:
        description: "CSV repo keys to index (matches your CLI --steps), e.g. blog,docs,tutorials,api"
        required: true
        default: "blog"
        type: choice
        options:
          - blog
          - docs
          - tutorials
          - api

      delete_missing:
        description: "If true, remove entries that no longer exist in source repos"
        required: true
        default: false
        type: boolean

      use_agent:
        description: "If true, run via Agents SDK triage+handoff (--use-agent)"
        required: true
        default: false
        type: boolean

      normalize_topics:
        description: "If true, LLM topic normalization for blogs (--normalize-topics)"
        required: true
        default: true
        type: boolean

      log_level:
        description: "Python log level"
        required: true
        default: "INFO"
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR

jobs:
  run-indexer:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    permissions:
      contents: read

    env:
      # Common env defaults (adjust to your project conventions)
      CG_REPO_ROOT: ${{ github.workspace }}
      CG_OUTPUTS_ROOT: ${{ github.workspace }}/outputs

      # Required by your CLI callback (you log its presence).
      # Put it in repo secrets: Settings > Secrets and variables > Actions
      PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}

      # Very likely needed if normalize_topics=true or use_agent=true
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f pyproject.toml ]; then
            # Works if your project is installable as a package
            pip install -e .
          else
            echo "No requirements.txt or pyproject.toml found. Please add one."
            exit 1
          fi

      - name: Run Content Indexing Agent
        shell: bash
        run: |
          set -euo pipefail

          BRAND="${{ inputs.brand_yaml }}"
          PRODUCT="${{ inputs.product_yaml }}"
          PLATFORM="${{ inputs.platform }}"
          STEPS="${{ inputs.steps }}"
          LOG_LEVEL="${{ inputs.log_level }}"

          # Map booleans to CLI flags
          DELETE_FLAG=""
          if [ "${{ inputs.delete_missing }}" = "true" ]; then
            DELETE_FLAG="--delete-missing"
          fi

          AGENT_FLAG="--no-agent"
          if [ "${{ inputs.use_agent }}" = "true" ]; then
            AGENT_FLAG="--use-agent"
          fi

          NORMALIZE_FLAG="--no-normalize-topics"
          if [ "${{ inputs.normalize_topics }}" = "true" ]; then
            NORMALIZE_FLAG="--normalize-topics"
          fi

          echo "Running indexing:"
          echo "  brand_yaml=$BRAND"
          echo "  product_yaml=$PRODUCT"
          echo "  platform=$PLATFORM"
          echo "  steps=$STEPS"
          echo "  delete_missing=${{ inputs.delete_missing }}"
          echo "  use_agent=${{ inputs.use_agent }}"
          echo "  normalize_topics=${{ inputs.normalize_topics }}"
          echo "  log_level=$LOG_LEVEL"
          echo "  outputs_root=$CG_OUTPUTS_ROOT"

          # Preferred: call the module directly (robust even if console scripts aren't installed).
          # Replace `agent_engine.content_indexing_agent.cli` with your actual module path if different.
          python -m agent_engine.content_indexing_agent.cli \
            --log-level "$LOG_LEVEL" \
            run \
            --brand "$BRAND" \
            --product "$PRODUCT" \
            --platform "$PLATFORM" \
            --steps "$STEPS" \
            $DELETE_FLAG \
            $AGENT_FLAG \
            $NORMALIZE_FLAG

      - name: Upload outputs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: content-indexing-outputs
          path: |
            outputs/**
          if-no-files-found: warn
