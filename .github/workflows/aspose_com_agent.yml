name: Generate Blog Post for aspose.com

on:
  workflow_dispatch:
    inputs:
      keywords_file:
        description: 'Keywords File (e.g., content/Aspose/output/449388a2_aspose-cells_java_topics.md)'
        required: true
        type: string
      
      author:
        description: 'Author Name'
        required: true
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Clean up old blog folders
      run: |
        # Remove any existing blog folders to avoid confusion
        echo "=== Cleaning up old blog folders ==="
        find content/blogPosts -type d -name "20??-??-??-*" -exec rm -rf {} + 2>/dev/null || true
        echo "✅ Cleanup completed"

    - name: Remove any .env files that could interfere
      run: |
        find . -name ".env" -type f -delete
        echo "Removed all .env files"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd agent_engine
        cd blog_generator
        pip install -r requirements.txt
        cd ..
        cd ..
        cd mcp-servers
        pip install -r requirements.txt
        cd ..

    - name: Create runtime .env file with secrets
      run: |
        cat > .env << EOF
        PROFESSIONALIZE_API_KEY=${{ secrets.PROFESSIONALIZE_API_KEY }}
        PROFESSIONALIZE_BASE_URL=${{ secrets.PROFESSIONALIZE_BASE_URL }}
        PROFESSIONALIZE_LLM_MODEL=${{ secrets.PROFESSIONALIZE_LLM_MODEL }}
        TOKEN_FOR_TEAM=${{ secrets.TOKEN_FOR_TEAM }}
        TOKEN_FOR_PROD=${{ secrets.TOKEN_FOR_PROD }}
        GOOGLE_SCRIPT_URL_FOR_PROD=${{ vars.GOOGLE_SCRIPT_URL_FOR_PROD }}
        GOOGLE_SCRIPT_URL_FOR_TEAM=${{ vars.GOOGLE_SCRIPT_URL_FOR_TEAM }}
        REPO_PAT=${{ secrets.GISTS_PAT_ASPOSE_COM }}
        GIST_NAME=${{ vars.ASPOSE_COM_GIST }}
        EOF
        echo ".env file created"

    - name: Generate Blog
      id: generate_blog
      run: |
        cd agent_engine
        cd blog_generator
        echo "=== Starting blog generation ==="
        echo "Brand: aspose.com"
        echo "Product: ${{ inputs.product }}"
        echo "Platform: ${{ inputs.platform }}"
        echo "Topic: ${{ inputs.topic }}"
        
        python main.py \
          --keywords_file "${{ inputs.keywords_file }}" \
          --brand "aspose.com" \
          --author "${{ inputs.author }}"
        
        echo "✅ Blog generation completed"

    - name: Find generated blog folder
      id: find_blog
      run: |
        echo "=== Searching for generated blog folder ==="
        
        # Search specifically in brand directory
        BRAND_DIR="content/blogPosts/aspose_com"
        
        if [ ! -d "$BRAND_DIR" ]; then
          echo "❌ Brand directory not found: $BRAND_DIR"
          exit 1
        fi
        
        echo "Searching in: $BRAND_DIR"
        
        # Find the most recently created folder (within last 10 minutes)
        blog_folder=$(find "$BRAND_DIR" -mindepth 1 -maxdepth 1 -type d -name "20??-??-??-*" -mmin -10 -printf '%T@ %p\n' | sort -nr | head -1 | cut -d' ' -f2-)
        
        if [ -z "$blog_folder" ]; then
          echo "❌ No blog folder found with pattern YYYY-MM-DD-* in $BRAND_DIR"
          echo "Contents of $BRAND_DIR:"
          ls -la "$BRAND_DIR" || echo "Directory is empty"
          exit 1
        fi
        
        echo "Found blog folder: $blog_folder"
        
        blog_folder_name=$(basename "$blog_folder")
        echo "Blog folder name: $blog_folder_name"
        
        # Verify index.md exists
        if [ ! -f "$blog_folder/index.md" ]; then
          echo "❌ index.md not found in $blog_folder"
          exit 1
        fi
        
        # Optional: Verify the brand in frontmatter
        if grep -q "aspose" "$blog_folder/index.md" 2>/dev/null; then
          echo "✅ Verified: Blog is for aspose.com"
        else
          echo "⚠️  Warning: Could not verify brand in frontmatter"
        fi
        
        echo "blog_folder_name=$blog_folder_name" >> $GITHUB_OUTPUT
        echo "blog_folder_path=$blog_folder" >> $GITHUB_OUTPUT
        
        echo "✅ Found: $blog_folder_name with index.md"
        echo "=== Folder contents ==="
        ls -la "$blog_folder"

    - name: Extract product folder name
      id: product_folder
      run: |
        # Convert product name to lowercase and remove "Aspose." prefix
        # Example: "Aspose.Slides" -> "slides"
        product_folder=$(echo "${{ inputs.product }}" | sed 's/Aspose\.//g' | tr '[:upper:]' '[:lower:]')
        echo "product_folder=$product_folder" >> $GITHUB_OUTPUT
        echo "✅ Product folder name: $product_folder"

    - name: Verify blog content before upload
      run: |
        echo "=== Verifying blog content ==="
        BLOG_PATH="${{ steps.find_blog.outputs.blog_folder_path }}"
        
        echo "Blog folder: $BLOG_PATH"
        echo "Expected brand: aspose.com"
        
        # Check frontmatter for brand indicators
        if [ -f "$BLOG_PATH/index.md" ]; then
          echo "--- Frontmatter excerpt ---"
          head -20 "$BLOG_PATH/index.md"
          echo "--- End excerpt ---"
        fi

    - name: Upload Generated Blog as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: generated-blog-aspose-${{ github.run_number }}
        path: ${{ steps.find_blog.outputs.blog_folder_path }}
        if-no-files-found: error
    # ####################################################################
    # # Create Pull Request in aspose-blog repo
    # ####################################################################
    # - name: Create Pull Request in blog.aspose.com repo
    #   if: success()
    #   env:
    #     BLOG_FOLDER_NAME: ${{ steps.find_blog.outputs.blog_folder_name }}
    #     BLOG_FOLDER_PATH: ${{ steps.find_blog.outputs.blog_folder_path }}
    #     GH_TOKEN: ${{ secrets.REPO_PAT }}
    #   run: |
    #     git config --global user.email "action@github.com"
    #     git config --global user.name "GitHub Action"

    #     if [ -z "${{ secrets.REPO_PAT }}" ]; then
    #       echo "❌ REPO_PAT is EMPTY! Fix your repo secret."
    #       exit 1
    #     fi

    #     echo "Cloning aspose-blog repo..."
    #     git clone https://x-access-token:${{ secrets.REPO_PAT }}@github.com/Aspose/aspose-blog.git aspose-blog || {
    #       echo "❌ Failed to clone repo — invalid PAT or wrong GitHub account."
    #       exit 1
    #     }

    #     cd aspose-blog
        
    #     # Ensure we're on master and it's up to date
    #     git checkout master
    #     git pull origin master
        
    #     # Create the target directory structure if it doesn't exist
    #     TARGET_DIR="content/Aspose.Blog"
    #     mkdir -p "$TARGET_DIR"
    #     echo "✅ Target directory: $TARGET_DIR"
        
    #     # Create a new branch for this blog post
    #     BRANCH_NAME="blog/$BLOG_FOLDER_NAME"
        
    #     # Check if branch exists remotely and delete it
    #     if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
    #       echo "⚠️  Branch $BRANCH_NAME already exists remotely. Deleting..."
    #       git push origin --delete "$BRANCH_NAME" || echo "Could not delete remote branch (may not exist)"
    #     fi
        
    #     # Delete local branch if it exists
    #     git branch -D "$BRANCH_NAME" 2>/dev/null || true
        
    #     # Create fresh branch from master
    #     git checkout -b "$BRANCH_NAME" master
        
    #     echo "Copying blog folder: $BLOG_FOLDER_NAME to $TARGET_DIR"
        
    #     # FIXED: Get absolute path to blog folder correctly
    #     WORKFLOW_DIR=$(pwd)
    #     cd ..
    #     REPO_ROOT=$(pwd)
    #     BLOG_ABS_PATH="$REPO_ROOT/$BLOG_FOLDER_PATH"
        
    #     echo "Repository root: $REPO_ROOT"
    #     echo "Blog relative path: $BLOG_FOLDER_PATH"
    #     echo "Blog absolute path: $BLOG_ABS_PATH"
        
    #     # Verify source exists before copying
    #     if [ ! -d "$BLOG_ABS_PATH" ]; then
    #       echo "❌ Source blog folder does not exist: $BLOG_ABS_PATH"
    #       echo "Checking what exists in content/blogPosts/aspose_com:"
    #       ls -la "$REPO_ROOT/content/blogPosts/aspose_com/" || echo "Directory doesn't exist"
    #       exit 1
    #     fi
        
    #     cd "$WORKFLOW_DIR"
        
    #     # Copy the blog folder to the correct directory
    #     cp -r "$BLOG_ABS_PATH" "$TARGET_DIR/" || {
    #       echo "❌ Failed to copy folder from $BLOG_ABS_PATH to $TARGET_DIR"
    #       exit 1
    #     }
        
    #     # Verify the copy was successful
    #     if [ ! -d "$TARGET_DIR/$BLOG_FOLDER_NAME" ]; then
    #       echo "❌ Blog folder was not copied successfully"
    #       echo "Target contents:"
    #       ls -la "$TARGET_DIR"
    #       exit 1
    #     fi
        
    #     echo "✅ Blog folder copied successfully"
    #     echo "=== Target folder contents ==="
    #     ls -la "$TARGET_DIR/$BLOG_FOLDER_NAME"
        
    #     # Add only the new blog folder
    #     git add "$TARGET_DIR/$BLOG_FOLDER_NAME"
        
    #     # Check what's being committed
    #     echo "=== Files to be committed ==="
    #     git status --short
        
    #     # Check if there are actually changes to commit
    #     if git diff --staged --quiet; then
    #       echo "ℹ️ No new files to commit - content may already exist"
    #       exit 0
    #     fi
        
    #     # Show what will be committed
    #     echo "=== Changes to be committed ==="
    #     git diff --staged --stat
        
    #     # Commit the changes
    #     git commit -m "Add generated blog: $BLOG_FOLDER_NAME" || {
    #       echo "❌ Failed to commit changes"
    #       exit 1
    #     }
        
    #     # Verify commit was created
    #     echo "=== Last commit ==="
    #     git log -1 --oneline
        
    #     # Push the branch (force push since we deleted and recreated)
    #     git push -u origin "$BRANCH_NAME" --force || {
    #       echo "❌ Failed to push branch."
    #       exit 1
    #     }
        
    #     echo "✅ Branch $BRANCH_NAME pushed successfully"
        
    #     # Wait a moment for GitHub to process the push
    #     sleep 2
        
    #     # Check if PR already exists for this branch
    #     EXISTING_PR=$(gh pr list --repo Aspose/aspose-blog --head "$BRANCH_NAME" --json number --jq '.[0].number' 2>/dev/null || echo "")
        
    #     if [ -n "$EXISTING_PR" ]; then
    #       echo "ℹ️  PR #$EXISTING_PR already exists for this branch"
    #       echo "PR URL: https://github.com/Aspose/aspose-blog/pull/$EXISTING_PR"
    #     else
    #       # Create Pull Request using GitHub CLI
    #       gh pr create \
    #         --repo Aspose/aspose-blog \
    #         --base master \
    #         --head "$BRANCH_NAME" \
    #         --title "Add blog post: $BLOG_FOLDER_NAME" \
    #         --body "## Generated Blog Post

    #       **Folder:** $BLOG_FOLDER_NAME
    #       **Author:** ${{ inputs.author }}
    #       **Target Path:** \`content/Aspose.Blog/$BLOG_FOLDER_NAME\`

    #       **Generated by:** GitHub Actions (Run #${{ github.run_number }})
    #       **Workflow:** ${{ github.workflow }}
    #       **Brand:** aspose.com

    #       ---

    #       This pull request adds a new blog post generated by the autonomous blog agent.

    #       ### Contents:
    #       - Folder: \`$BLOG_FOLDER_NAME\`
    #       - File: \`index.md\`
    #       - Location: \`content/Aspose.Blog/\`

    #       Please review and merge if the content looks good!" || {
    #         echo "❌ Failed to create pull request."
    #         echo "Attempting to show branch diff..."
    #         git log origin/master..$BRANCH_NAME --oneline
    #         exit 1
    #       }
          
    #       echo "✅ Pull request created successfully!"
    #     fi