name: Content Gap Analyzer for Aspose

on:
  workflow_dispatch:
    inputs:
      product:
        description: "Product to analyze"
        required: true
        type: choice
        options:
          - "cells"
        default: "cells"
      platform:
        description: "Platform to analyze"
        required: true
        type: choice
        options:
          - "net"
          - "java"
          - "python_net"
          - "cpp"
          - "android"
          - "nodejs"
        default: "net"
      mode:
        description: "Pipeline mode to run"
        required: true
        type: choice
        options:
          - "index"
          - "coverage"
          - "semantic-coverage"
          - "semantic-analyze"
          - "analyze"
          - "run-all"
        default: "run-all"
      case:
        description: "Semantic coverage case"
        required: false
        type: choice
        options:
          - ""
          - "docs_to_blogs"
          - "docs_to_tutorials"
          - "blogs_to_blogs"
        default: ""
      flush:
        description: "Clear cache/output before running"
        required: false
        type: boolean
        default: false
      force:
        description: "Force re-run even if step is complete"
        required: false
        type: boolean
        default: false

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git credentials for private repos (PAT via x-access-token)
        env:
          ASPOSE_BLOG_TOKEN: ${{ secrets.ASPOSE_BLOG_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${ASPOSE_BLOG_TOKEN}" ]; then
            echo "ASPOSE_BLOG_TOKEN is empty or not available to this workflow run."
            exit 1
          fi

          # Rewrite any https://github.com/... clone URL to include the token.
          git config --global url."https://x-access-token:${ASPOSE_BLOG_TOKEN}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://x-access-token:${ASPOSE_BLOG_TOKEN}@github.com/".insteadOf "http://github.com/"
          # If any tooling uses SSH-style urls, rewrite those too (optional, but helpful).
          git config --global url."https://x-access-token:${ASPOSE_BLOG_TOKEN}@github.com/".insteadOf "git@github.com:"

          # Fail fast instead of prompting (Actions runner is non-interactive).
          git config --global core.askPass ""
          git config --global credential.helper ""

      - name: Show git url rewrite rules (safe)
        run: |
          git config --global --get-regexp '^url\..*\.insteadOf$' || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Aspose Blog Analysis
        env:
          # Prevent any git prompt from hanging/failing obscurely.
          GIT_TERMINAL_PROMPT: "0"

          PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
          PROFESSIONALIZE_BASE_URL: ${{ secrets.PROFESSIONALIZE_BASE_URL }}
          PROFESSIONALIZE_LLM_MODEL: ${{ secrets.PROFESSIONALIZE_LLM_MODEL }}
          PROFESSIONALIZE_EMBEDDING_MODEL: ${{ secrets.PROFESSIONALIZE_EMBEDDING_MODEL }}
        run: |
          set -euo pipefail

          # Build base arguments
          ARGS="--brand aspose --product ${{ github.event.inputs.product }} --platform ${{ github.event.inputs.platform }}"

          # Add mode flag
          MODE="${{ github.event.inputs.mode }}"
          case "$MODE" in
            "index")
              ARGS="$ARGS --index"
              ;;
            "coverage")
              ARGS="$ARGS --coverage"
              ;;
            "semantic-coverage")
              ARGS="$ARGS --semantic-coverage"
              ;;
            "semantic-analyze")
              ARGS="$ARGS --semantic-analyze"
              ;;
            "analyze")
              ARGS="$ARGS --analyze"
              ;;
            "run-all")
              ARGS="$ARGS --run-all"
              ;;
          esac

          # Add case if specified
          if [ -n "${{ github.event.inputs.case }}" ]; then
            ARGS="$ARGS --case ${{ github.event.inputs.case }}"
          fi

          # Add flush flag if enabled
          if [ "${{ github.event.inputs.flush }}" == "true" ]; then
            ARGS="$ARGS --flush"
          fi

          # Add force flag if enabled
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            ARGS="$ARGS --force"
          fi

          echo "Running: python -m agent_engine.content_gap_agent $ARGS"
          python -m agent_engine.content_gap_agent $ARGS

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: aspose-${{ github.event.inputs.product }}-${{ github.event.inputs.platform }}-results
          path: |
            outputs/
          retention-days: 30
