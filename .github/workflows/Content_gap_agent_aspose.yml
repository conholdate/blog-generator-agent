name: Content Gap Analyzer for Aspose

on:
  workflow_dispatch:
    inputs:
      product:
        description: "Product to analyze"
        required: true
        type: choice
        options:
          - "cells"
        default: "cells"
      platform:
        description: "Platform to analyze"
        required: true
        type: choice
        options:
          - "net"
          - "java"
          - "python_net"
          - "cpp"
          - "android"
          - "nodejs"
        default: "net"
      mode:
        description: "Pipeline mode to run"
        required: true
        type: choice
        options:
          - "index"
          - "coverage"
          - "semantic-coverage"
          - "semantic-analyze"
          - "analyze"
          - "run-all"
        default: "run-all"
      case:
        description: "Semantic coverage case"
        required: false
        type: choice
        options:
          - ""
          - "docs_to_blogs"
          - "docs_to_tutorials"
          - "blogs_to_blogs"
        default: ""
      flush:
        description: "Clear cache/output before running"
        required: false
        type: boolean
        default: false
      force:
        description: "Force re-run even if step is complete"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Aspose blog repo
        uses: actions/checkout@v4
        with:
          repository: Aspose/aspose-blog
          path: repo_cache/aspose-blog
          token: ${{ secrets.ASPOSE_BLOG_TOKEN }}
          fetch-depth: 0

      - name: Checkout Cells docs repo
        uses: actions/checkout@v4
        with:
          repository: aspose-cells/Aspose.Cells-Doc-md
          path: repo_cache/Aspose.Cells-Doc-md
          token: ${{ secrets.ASPOSE_BLOG_TOKEN }}
          fetch-depth: 0

      - name: Checkout Cells API refs repo
        uses: actions/checkout@v4
        with:
          repository: aspose-cells/Aspose.Cells-API-References
          path: repo_cache/Aspose.Cells-API-References
          token: ${{ secrets.ASPOSE_BLOG_TOKEN }}
          fetch-depth: 0

      - name: Checkout Cells tutorials repo
        uses: actions/checkout@v4
        with:
          repository: aspose-cells/Aspose-Cells-Tutorials
          path: repo_cache/Aspose-Cells-Tutorials
          token: ${{ secrets.ASPOSE_BLOG_TOKEN }}
          fetch-depth: 0


      - name: Verify PAT can access required GitHub repos
        env:
          ASPOSE_BLOG_TOKEN: ${{ secrets.ASPOSE_BLOG_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${ASPOSE_BLOG_TOKEN:-}" ]; then
            echo "ASPOSE_BLOG_TOKEN is empty or not available to this run."
            exit 1
          fi

          echo "1) Checking via GitHub API (does not expose token)..."
          check_repo_api () {
            local repo="$1"
            local code
            code="$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${ASPOSE_BLOG_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${repo}")"
            echo "API access ${repo}: HTTP ${code}"
            if [ "${code}" != "200" ]; then
              echo "FAIL: Token cannot access ${repo}. (401=bad token, 404=no access/repo, 403=SSO/policy)"
              exit 1
            fi
          }

          check_repo_api "Aspose/aspose-blog"
          check_repo_api "aspose-cells/Aspose.Cells-Doc-md"
          check_repo_api "aspose-cells/Aspose.Cells-API-References"
          check_repo_api "aspose-cells/Aspose-Cells-Tutorials"

          echo
          echo "2) Checking via git (GIT_ASKPASS, token never in URL)..."
          cat > /tmp/git-askpass.sh <<'EOF'
          #!/usr/bin/env bash
          case "$1" in
            *Username*) echo "x-access-token" ;;
            *Password*) echo "${ASPOSE_BLOG_TOKEN}" ;;
            *) echo "${ASPOSE_BLOG_TOKEN}" ;;
          esac
          EOF
          chmod +x /tmp/git-askpass.sh

          export GIT_ASKPASS=/tmp/git-askpass.sh
          export GIT_TERMINAL_PROMPT=0

          git ls-remote https://github.com/Aspose/aspose-blog.git HEAD >/dev/null
          git ls-remote https://github.com/aspose-cells/Aspose.Cells-Doc-md.git HEAD >/dev/null

          echo "PAT authentication checks passed."

      - name: Configure Git URL rewrite for private clones (scoped)
        env:
          ASPOSE_BLOG_TOKEN: ${{ secrets.ASPOSE_BLOG_TOKEN }}
          CONTENT_GAP_REPO_FETCH: zip           # forces zipball mode (recommended)
          CONTENT_GAP_EPHEMERAL_REPOS: "1"      # delete repos after indexing
        run: |
          set -euo pipefail
          if [ -z "${ASPOSE_BLOG_TOKEN:-}" ]; then
            echo "ASPOSE_BLOG_TOKEN is empty or not available."
            exit 1
          fi

          # Rewrite ONLY the orgs you need (avoids interfering with pushing to current repo)
          git config --global url."https://x-access-token:${ASPOSE_BLOG_TOKEN}@github.com/Aspose/".insteadOf "https://github.com/Aspose/"
          git config --global url."https://x-access-token:${ASPOSE_BLOG_TOKEN}@github.com/aspose-cells/".insteadOf "https://github.com/aspose-cells/"

          # Safe debug output (does not print token)
          git config --global --get-regexp '^url\..*\.insteadOf$' || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Aspose Blog Analysis
        working-directory: ${{ github.workspace }}
        env:
          GIT_TERMINAL_PROMPT: "0"
          BTA_CONFIG_DIR: ${{ github.workspace }}/config
          PROFESSIONALIZE_API_KEY: ${{ secrets.PROFESSIONALIZE_API_KEY }}
          PROFESSIONALIZE_BASE_URL: ${{ secrets.PROFESSIONALIZE_BASE_URL }}
          PROFESSIONALIZE_LLM_MODEL: ${{ secrets.PROFESSIONALIZE_LLM_MODEL }}
          PROFESSIONALIZE_EMBEDDING_MODEL: ${{ secrets.PROFESSIONALIZE_EMBEDDING_MODEL }}
        run: |
          set -euo pipefail

          ARGS="--brand aspose --product ${{ github.event.inputs.product }} --platform ${{ github.event.inputs.platform }}"

          MODE="${{ github.event.inputs.mode }}"
          case "$MODE" in
            "index") ARGS="$ARGS --index" ;;
            "coverage") ARGS="$ARGS --coverage" ;;
            "semantic-coverage") ARGS="$ARGS --semantic-coverage" ;;
            "semantic-analyze") ARGS="$ARGS --semantic-analyze" ;;
            "analyze") ARGS="$ARGS --analyze" ;;
            "run-all") ARGS="$ARGS --run-all" ;;
          esac

          if [ -n "${{ github.event.inputs.case }}" ]; then
            ARGS="$ARGS --case ${{ github.event.inputs.case }}"
          fi
          if [ "${{ github.event.inputs.flush }}" == "true" ]; then
            ARGS="$ARGS --flush"
          fi
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            ARGS="$ARGS --force"
          fi

          echo "Running: python -m agent_engine.content_gap_agent $ARGS"
          python -m agent_engine.content_gap_agent $ARGS

      - name: Commit and push outputs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage only outputs
          git add outputs/ || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update content gap outputs (${GITHUB_RUN_ID})"

          # Ensure push uses the workflow token (robust even with url.rewrite present)
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          git pull --rebase origin "${GITHUB_REF_NAME}"
          git push origin "HEAD:${GITHUB_REF_NAME}"

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: aspose-${{ github.event.inputs.product }}-${{ github.event.inputs.platform }}-results
          path: |
            outputs/
          retention-days: 30
